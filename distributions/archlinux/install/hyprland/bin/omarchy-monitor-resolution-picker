#!/bin/bash

# Script am√©lior√© pour changer la r√©solution et l'√©chelle d'un √©cran sous Hyprland.
# Utilise fzf pour la s√©lection interactive et gum pour la confirmation.

# Stoppe le script en cas d'erreur
set -euo pipefail

# -- V√©rification des d√©pendances --
check_deps() {
  for cmd in hyprctl jq fzf gum; do
    if ! command -v "$cmd" &> /dev/null; then
      gum style --bold --foreground="197" "Erreur : La commande '$cmd' est introuvable."
      echo "Veuillez l'installer pour utiliser ce script."
      exit 1
    fi
  done
}

# Fonction principale
main() {
  # -- √âtape 1 : R√©cup√©rer les informations de tous les moniteurs (un seul appel) --
  monitors_json=$(hyprctl monitors -j)

  if [[ -z "$monitors_json" || "$monitors_json" == "[]" ]]; then
    gum style --bold --foreground="197" "Aucun moniteur d√©tect√© par Hyprland."
    exit 1
  fi

  # -- √âtape 2 : S√©lectionner un moniteur --
  # Formatage de la liste pour fzf: Nom  R√©solution@Rafra√Æchissement  (actuel)
  monitor_list=$(echo "$monitors_json" | jq -r '.[] | "\(.name)\t\(.width)x\(.height)@\(.refreshRate | floor)Hz\t\(if .focused then "(actuel)" else "" end)"')
  
  # Pr√©-s√©lectionne le moniteur qui a le focus
  focused_monitor=$(echo "$monitors_json" | jq -r '.[] | select(.focused) | .name')

  selected_monitor_line=$(echo -e "$monitor_list" | fzf --prompt="üì∫ Quel moniteur configurer ? " --height="25%" --border=rounded --query="$focused_monitor" --with-nth=1,2)
  
  # Quitte si l'utilisateur appuie sur Echap
  [[ -z "$selected_monitor_line" ]] && gum style --foreground="248" "Aucune s√©lection. Op√©ration annul√©e." && exit 0

  monitor_name=$(echo "$selected_monitor_line" | cut -f1)
  
  # Isoler les d√©tails du moniteur s√©lectionn√© pour les √©tapes suivantes
  monitor_details=$(echo "$monitors_json" | jq --arg MON "$monitor_name" '.[] | select(.name == $MON)')

  gum style "Moniteur s√©lectionn√© : " --bold --foreground="86" "$monitor_name"
  echo # Saut de ligne

  # -- √âtape 3 : S√©lectionner une r√©solution --
  available_modes=$(echo "$monitor_details" | jq -r '.availableModes[]')
  current_mode=$(echo "$monitor_details" | jq -r '"\(.width)x\(.height)@\(.refreshRate | floor)Hz"')
  
  # fzf recherche la r√©solution actuelle dans la liste
  chosen_mode_raw=$(echo "$available_modes" | fzf --prompt="üìè Quelle r√©solution choisir ? " --height="40%" --border=rounded --query="$current_mode")
  [[ -z "$chosen_mode_raw" ]] && gum style --foreground="248" "Aucune s√©lection. Op√©ration annul√©e." && exit 0
  
  # Garder uniquement la partie "largeurxhauteur@refreshRate"
  chosen_mode=$(echo "$chosen_mode_raw" | sed -E 's/@([0-9]+)\.[0-9]+Hz/@\1Hz/' | cut -d' ' -f1)


  # -- √âtape 4 : S√©lectionner l'√©chelle (scale) --
  scale_options=("1" "1.25" "1.5" "1.75" "2")
  current_scale=$(echo "$monitor_details" | jq -r '.scale')

  chosen_scale=$(printf "%s\n" "${scale_options[@]}" | fzf --prompt="üîé Quelle √©chelle appliquer ? " --height="25%" --border=rounded --query="$current_scale")
  [[ -z "$chosen_scale" ]] && gum style --foreground="248" "Aucune s√©lection. Op√©ration annul√©e." && exit 0


  # -- √âtape 5 : Pr√©parer et confirmer la commande --
  position=$(echo "$monitor_details" | jq -r '"\(.x)x\(.y)"')
  
  cmd="hyprctl keyword monitor \"$monitor_name,${chosen_mode},$position,$chosen_scale\""

  gum style --border=double --padding="1 2" --border-foreground="86" --align=center \
    "Configuration √† appliquer :" \
    "  Moniteur  : $monitor_name" \
    "  R√©solution: $chosen_mode" \
    "  Position  : $position" \
    "  √âchelle   : $chosen_scale"

  echo # Saut de ligne
  
  if gum confirm "Voulez-vous ex√©cuter cette commande ?" --affirmative="‚úÖ Oui" --negative="‚ùå Non"; then
    eval "$cmd"
    gum style --bold --foreground="82" "‚úÖ Configuration appliqu√©e avec succ√®s !"
  else
    gum style --foreground="197" "‚ùå Op√©ration annul√©e par l'utilisateur."
  fi
}

# --- Lancement du script ---
check_deps
main