#!/bin/bash

set -euo pipefail

# Step 1: list monitors with their current resolution
monitors=$(hyprctl monitors -j | jq -r '.[] | "\(.name)\t\(.width)x\(.height)@\(.refreshRate)"')

if [[ -z "$monitors" ]]; then
  echo "No monitors detected via hyprctl"
  exit 1
fi

selected=$(echo "$monitors" | fzf --prompt="Select a monitor: " --with-nth=1,2 --delimiter=$'\t')
[[ -z "$selected" ]] && exit 0

monitor_name=$(echo "$selected" | cut -f1)
echo "Selected monitor: $monitor_name"

# Step 2: list available resolutions for this monitor
modes=$(hyprctl monitors -j | jq -r --arg MON "$monitor_name" '.[] | select(.name == $MON) | .availableModes[]')

if [[ -z "$modes" ]]; then
  echo "No available modes found for $monitor_name"
  exit 1
fi

chosen_mode=$(echo "$modes" | fzf --prompt="Select a resolution: ")
[[ -z "$chosen_mode" ]] && exit 0

# Step 3: get current scale
current_scale=$(hyprctl monitors -j | jq -r --arg MON "$monitor_name" '.[] | select(.name == $MON) | .scale')

# Step 4: list common scales with current scale marked
scale_options=("1" "1.25" "1.5" "1.75" "2")
scale_list=()
for s in "${scale_options[@]}"; do
  if [[ "$s" == "$current_scale" ]]; then
    scale_list+=("â†’ $s (current)")
  else
    scale_list+=("  $s")
  fi
done

chosen_scale=$(printf "%s\n" "${scale_list[@]}" | fzf --prompt="Select scale: " | awk '{print $2}')
[[ -z "$chosen_scale" ]] && exit 0

# Step 5: get current position for this monitor
position=$(hyprctl monitors -j | jq -r --arg MON "$monitor_name" '.[] | select(.name == $MON) | "\(.x)x\(.y)"')

# Step 6: apply new configuration
cmd="hyprctl keyword monitor \"$monitor_name,$chosen_mode,$position,$chosen_scale\""
echo "Applying: $cmd"
eval $cmd

notify-send "Monitor $monitor_name set to $chosen_mode at scale $chosen_scale"