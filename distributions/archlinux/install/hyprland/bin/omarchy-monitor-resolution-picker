#!/bin/bash

# Script am√©lior√© pour changer la r√©solution et l'√©chelle d'un √©cran sous Hyprland.
# Utilise fzf pour la s√©lection interactive et gum pour la confirmation.

# Stoppe le script en cas d'erreur
set -euo pipefail

# -- V√©rification des d√©pendances --
check_deps() {
  for cmd in hyprctl jq fzf gum; do
    if ! command -v "$cmd" &> /dev/null; then
      echo "Erreur : La commande '$cmd' est introuvable." >&2
      echo "Veuillez l'installer pour utiliser ce script." >&2
      exit 1
    fi
  done
}

# Fonction principale
main() {
  # -- √âtape 1 : R√©cup√©rer les informations de tous les moniteurs (un seul appel) --
  monitors_json=$(hyprctl monitors -j)

  if [[ -z "$monitors_json" || "$monitors_json" == "[]" ]]; then
    echo "Aucun moniteur d√©tect√© par Hyprland." >&2
    exit 1
  fi

  # -- √âtape 2 : S√©lectionner un moniteur --
  # Formatage de la liste pour fzf: Nom  R√©solution@Rafra√Æchissement  (actuel, en italique si focus)
  monitor_list=$(echo "$monitors_json" | jq -r '.[] |
    (.name) + "\t" +
    (if .focused
      then "\u001b[3m\(.width)x\(.height)@\(.refreshRate | floor)Hz\u001b[0m"
      else        "\(.width)x\(.height)@\(.refreshRate | floor)Hz"
     end) + "\t" +
    (if .focused then "\u001b[3m(actuel)\u001b[0m" else "" end)')

  # Pr√©-s√©lectionne le moniteur qui a le focus (affichage uniquement, plus de --query)
  focused_monitor=$(echo "$monitors_json" | jq -r '.[] | select(.focused) | .name')

  selected_monitor_line=$(echo -e "$monitor_list" | fzf --ansi --prompt="üì∫ Quel moniteur configurer ? " --height="25%" --border=rounded --with-nth=1,2)
  
  # Quitte si l'utilisateur appuie sur Echap
  if [[ -z "$selected_monitor_line" ]]; then
    echo "Aucune s√©lection. Op√©ration annul√©e."
    exit 0
  fi

  monitor_name=$(echo "$selected_monitor_line" | cut -f1)
  
  # Isoler les d√©tails du moniteur s√©lectionn√© pour les √©tapes suivantes
  monitor_details=$(echo "$monitors_json" | jq --arg MON "$monitor_name" '.[] | select(.name == $MON)')

  echo "Moniteur s√©lectionn√© : $monitor_name"
  echo

  # -- √âtape 3 : S√©lectionner une r√©solution --
  available_modes=$(echo "$monitor_details" | jq -r '.availableModes[]')
  current_mode=$(echo "$monitor_details" | jq -r '"\(.width)x\(.height)@\(.refreshRate | floor)Hz"')
  
  # Liste avec la r√©solution actuelle en italique
  available_modes_ansi=$(
    while IFS= read -r line; do
      token="${line%% *}"
      token_int=$(echo "$token" | sed -E 's/@([0-9]+)\.[0-9]+Hz/@\1Hz/')
      if [[ "$token_int" == "$current_mode" ]]; then
        printf "\e[3m%s\e[0m\n" "$line"
      else
        printf "%s\n" "$line"
      fi
    done <<< "$available_modes"
  )

  chosen_mode_raw=$(echo "$available_modes_ansi" | fzf --ansi --prompt="üìè Quelle r√©solution choisir ? " --height="40%" --border=rounded)
  if [[ -z "$chosen_mode_raw" ]]; then
    echo "Aucune s√©lection. Op√©ration annul√©e."
    exit 0
  fi

  # Nettoyer les codes ANSI √©ventuels
  chosen_mode_raw=$(printf "%s" "$chosen_mode_raw" | sed -r 's/\x1B\[[0-9;]*[mK]//g')

  # Garder uniquement la partie "largeurxhauteur@refreshRate"
  chosen_mode=$(echo "$chosen_mode_raw" | sed -E 's/@([0-9]+)\.[0-9]+Hz/@\1Hz/' | cut -d' ' -f1)


  # -- √âtape 4 : S√©lectionner l'√©chelle (scale) --
  scale_options=("1" "1.25" "1.5" "1.75" "2")
  current_scale=$(echo "$monitor_details" | jq -r '.scale')

  # Liste avec l'√©chelle actuelle en italique
  scale_list=$(
    for s in "${scale_options[@]}"; do
      if [[ "$s" == "$current_scale" ]]; then
        printf "\e[3m%s\e[0m\n" "$s"
      else
        printf "%s\n" "$s"
      fi
    done
  )

  chosen_scale=$(echo "$scale_list" | fzf --ansi --prompt="üîé Quelle √©chelle appliquer ? " --height="25%" --border=rounded)
  if [[ -z "$chosen_scale" ]]; then
    echo "Aucune s√©lection. Op√©ration annul√©e."
    exit 0
  fi

  # Nettoyer les codes ANSI √©ventuels
  chosen_scale=$(printf "%s" "$chosen_scale" | sed -r 's/\x1B\[[0-9;]*[mK]//g')

  # -- √âtape 5 : Pr√©parer et confirmer la commande --
  position=$(echo "$monitor_details" | jq -r '"\(.x)x\(.y)"')
  
  cmd="hyprctl keyword monitor \"$monitor_name,${chosen_mode},$position,$chosen_scale\""

  echo "Configuration √† appliquer :"
  echo "  Moniteur  : $monitor_name"
  echo "  R√©solution: $chosen_mode"
  echo "  Position  : $position"
  echo "  √âchelle   : $chosen_scale"
  echo

  if gum confirm "Voulez-vous ex√©cuter cette commande ?" --affirmative="‚úÖ Oui" --negative="‚ùå Non"; then
    eval "$cmd"
    echo "‚úÖ Configuration appliqu√©e avec succ√®s !"
  else
    echo "‚ùå Op√©ration annul√©e par l'utilisateur."
  fi
}

# --- Lancement du script ---
check_deps
main