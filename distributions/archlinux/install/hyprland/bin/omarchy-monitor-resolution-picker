#!/bin/bash

# Script am√©lior√© pour changer la r√©solution et l'√©chelle d'un √©cran sous Hyprland.
# Utilise fzf pour la s√©lection interactive et gum pour la confirmation.

# Stoppe le script en cas d'erreur
set -euo pipefail

# -- V√©rification des d√©pendances --
check_deps() {
  for cmd in hyprctl jq fzf gum; do
    if ! command -v "$cmd" &> /dev/null; then
      echo "Erreur : La commande '$cmd' est introuvable." >&2
      echo "Veuillez l'installer pour utiliser ce script." >&2
      exit 1
    fi
  done
}

# Fonction principale
main() {
  # -- √âtape 1 : R√©cup√©rer les informations de tous les moniteurs (un seul appel) --
  monitors_json=$(hyprctl monitors -j)

  if [[ -z "$monitors_json" || "$monitors_json" == "[]" ]]; then
    echo "Aucun moniteur d√©tect√© par Hyprland." >&2
    exit 1
  fi

  # -- √âtape 2 : S√©lectionner un moniteur --
  # Formatage de la liste pour fzf: Nom  R√©solution@Rafra√Æchissement  (actuel)
  monitor_list=$(echo "$monitors_json" | jq -r '.[] | "\(.name)\t\(.width)x\(.height)@\(.refreshRate | floor)Hz\t\(if .focused then "(actuel)" else "" end)"')
  
  # Pr√©-s√©lectionne le moniteur qui a le focus
  focused_monitor=$(echo "$monitors_json" | jq -r '.[] | select(.focused) | .name')

  selected_monitor_line=$(echo -e "$monitor_list" | fzf --prompt="üì∫ Quel moniteur configurer ? " --height="25%" --border=rounded --query="$focused_monitor" --with-nth=1,2)
  
  # Quitte si l'utilisateur appuie sur Echap
  if [[ -z "$selected_monitor_line" ]]; then
    echo "Aucune s√©lection. Op√©ration annul√©e."
    exit 0
  fi

  monitor_name=$(echo "$selected_monitor_line" | cut -f1)
  
  # Isoler les d√©tails du moniteur s√©lectionn√© pour les √©tapes suivantes
  monitor_details=$(echo "$monitors_json" | jq --arg MON "$monitor_name" '.[] | select(.name == $MON)')

  echo "Moniteur s√©lectionn√© : $monitor_name"
  echo

  # -- √âtape 3 : S√©lectionner une r√©solution --
  available_modes=$(echo "$monitor_details" | jq -r '.availableModes[]')
  current_mode=$(echo "$monitor_details" | jq -r '"\(.width)x\(.height)@\(.refreshRate | floor)Hz"')
  
  # fzf recherche la r√©solution actuelle dans la liste
  chosen_mode_raw=$(echo "$available_modes" | fzf --prompt="üìè Quelle r√©solution choisir ? " --height="40%" --border=rounded --query="$current_mode")
  if [[ -z "$chosen_mode_raw" ]]; then
    echo "Aucune s√©lection. Op√©ration annul√©e."
    exit 0
  fi
  
  # Garder uniquement la partie "largeurxhauteur@refreshRate"
  chosen_mode=$(echo "$chosen_mode_raw" | sed -E 's/@([0-9]+)\.[0-9]+Hz/@\1Hz/' | cut -d' ' -f1)


  # -- √âtape 4 : S√©lectionner l'√©chelle (scale) --
  scale_options=("1" "1.25" "1.5" "1.75" "2")
  current_scale=$(echo "$monitor_details" | jq -r '.scale')

  chosen_scale=$(printf "%s\n" "${scale_options[@]}" | fzf --prompt="üîé Quelle √©chelle appliquer ? " --height="25%" --border=rounded --query="$current_scale")
  if [[ -z "$chosen_scale" ]]; then
    echo "Aucune s√©lection. Op√©ration annul√©e."
    exit 0
  fi

  # -- √âtape 5 : Pr√©parer et confirmer la commande --
  position=$(echo "$monitor_details" | jq -r '"\(.x)x\(.y)"')
  
  cmd="hyprctl keyword monitor \"$monitor_name,${chosen_mode},$position,$chosen_scale\""

  echo "Configuration √† appliquer :"
  echo "  Moniteur  : $monitor_name"
  echo "  R√©solution: $chosen_mode"
  echo "  Position  : $position"
  echo "  √âchelle   : $chosen_scale"
  echo

  if gum confirm "Voulez-vous ex√©cuter cette commande ?" --affirmative="‚úÖ Oui" --negative="‚ùå Non"; then
    eval "$cmd"
    echo "‚úÖ Configuration appliqu√©e avec succ√®s !"
  else
    echo "‚ùå Op√©ration annul√©e par l'utilisateur."
  fi
}

# --- Lancement du script ---
check_deps
main